<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Dollar Beer Night</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {font-family: Arial; padding:10px; background:#f4f4f4;}
input,button {
  width:100%; padding:10px; margin:5px 0;
  border-radius:6px; border:1px solid #ccc;
}
button {background:#2563eb; color:white;}
#map {height:350px; margin-top:10px;}
.result {background:white; padding:10px; margin-top:5px;}
</style>
</head>

<body>

<h2>üç∫ Dollar Beer Night</h2>

<h3>Add Special</h3>
<input id="name" placeholder="Bar Name">
<input id="deal" placeholder="$1.50 cans etc">
<input id="address" placeholder="City / State / Address">
<input id="day" placeholder="Sunday-Saturday">
<button onclick="saveSpecial()">Save Special</button>

<h3>Find Beer Near Me</h3>
<button onclick="findBars()">Find Bars</button>

<div id="map"></div>
<div id="results"></div>

<script>
let map = L.map('map').setView([41.1,-80.6], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userMarker;
let markers = [];


function saveSpecial(){
  fetch("/api/add", {
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      name: name.value,
      deal: deal.value,
      address: address.value,
      day: day.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    alert("Saved!");
    document.querySelectorAll("input").forEach(i=>i.value="");
  });
}


function findBars(){
navigator.geolocation.getCurrentPosition(pos=>{
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;

  if(userMarker) map.removeLayer(userMarker);
  userMarker = L.marker([lat,lng]).addTo(map)
      .bindPopup("You are here").openPopup();

  fetch(`/api/find?lat=${lat}&lng=${lng}`)
  .then(r=>r.json())
  .then(data=>{

    markers.forEach(m=>map.removeLayer(m));
    markers=[];

    results.innerHTML="";

    data.forEach(b=>{
      const m = L.marker([b.lat,b.lng]).addTo(map)
          .bindPopup(`${b.name}<br>${b.deal}<br>${b.distance} miles`);
      markers.push(m);

      results.innerHTML += `
        <div class="result">
        <b>${b.name}</b> ‚Äî ${b.deal}<br>
        ${b.distance} miles away<br>
        ${b.validated ? "‚úÖ Validated" : "User Entry"}
        </div>
      `;
    });

  });
});
}
</script>

</body>
</html>
