<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>üç∫ Dollar Beer Night</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {font-family: Arial; padding:20px;}
input,button {width:100%; padding:10px; margin:5px 0;}
#map {height:400px; margin-top:10px;}
.card {
  background:#eee;
  padding:8px;
  margin:6px 0;
}
</style>
</head>

<body>

<h1>üç∫ Dollar Beer Night</h1>

<h3>Add Special</h3>

<input id="name" placeholder="Bar Name">
<input id="deal" placeholder="Deal">
<input id="address" placeholder="City/State or Address">

<button onclick="save()">Save Special</button>
<button onclick="locate()">Locate Me</button>

<div id="map"></div>
<div id="list"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map("map").setView([41.1,-80.65],11);
let userLat=null,userLon=null;

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ---- GEOCODING ----
async function geocode(addr){
 const r=await fetch(
  `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`
 );
 const d=await r.json();
 if(!d.length){alert("Address not found");return null;}
 return {lat:+d[0].lat,lon:+d[0].lon};
}

// ---- DISTANCE ----
function dist(a,b,c,d){
 const R=3958.8;
 const dLat=(c-a)*Math.PI/180;
 const dLon=(d-b)*Math.PI/180;
 const x=Math.sin(dLat/2)**2+
 Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
 Math.sin(dLon/2)**2;
 return (2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))).toFixed(1);
}

// ---- SAVE SPECIAL ----
async function save(){
 const name=document.getElementById("name").value;
 const deal=document.getElementById("deal").value;
 const addr=document.getElementById("address").value;

 const coords=await geocode(addr);
 if(!coords)return;

 await fetch("/api/specials",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({name,deal,addr,...coords})
 });

 load();
}

// ---- LOAD SPECIALS ----
async function load(){
 const r=await fetch("/api/specials");
 const data=await r.json();

 document.getElementById("list").innerHTML="";

 data.forEach(s=>{
  L.marker([s.lat,s.lon])
   .addTo(map)
   .bindPopup(`<b>${s.name}</b><br>${s.deal}`);

  let d=userLat?` (${dist(userLat,userLon,s.lat,s.lon)} mi)`:"";

  document.getElementById("list").innerHTML+=
   `<div class="card"><b>${s.name}</b>
   <br>${s.deal}<br>${s.addr}${d}</div>`;
 });
}

// ---- LOCATE USER ----
function locate(){
 navigator.geolocation.getCurrentPosition(p=>{
  userLat=p.coords.latitude;
  userLon=p.coords.longitude;
  map.setView([userLat,userLon],13);
  L.marker([userLat,userLon])
   .addTo(map)
   .bindPopup("You are here").openPopup();
  load();
 });
}

load();
</script>

</body>
</html>
