<!DOCTYPE html>
<html>
<head>
<title>Dollar Beer Night</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet"
 href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body {font-family:Arial; max-width:800px; margin:auto; padding:20px;}
button {padding:12px; background:#2e7dff; color:white; border:none;}
.card {background:#eee; padding:12px; margin:10px 0;}
#map {height:300px; margin-top:20px;}
input, textarea {width:100%; padding:10px; margin:6px 0;}
</style>
</head>

<body>

<h2>üç∫ Dollar Beer Night</h2>

<form action="/add" method="POST">
<input name="bar" placeholder="Bar Name" required>
<input name="price" placeholder="Drink Price">
<input name="day" placeholder="Day">
<textarea name="notes" placeholder="Notes"></textarea>

<input type="hidden" name="lat" id="lat">
<input type="hidden" name="lon" id="lon">

<button>Add Special</button>
</form>

<hr>

<button onclick="findBars()">Find Specials Near Me</button>

<div id="map"></div>
<div id="results"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let userLat=null,userLon=null,map;

// Get GPS
navigator.geolocation.getCurrentPosition(pos=>{
 userLat=pos.coords.latitude;
 userLon=pos.coords.longitude;
 document.getElementById("lat").value=userLat;
 document.getElementById("lon").value=userLon;
 initMap();
});

// Map setup
function initMap(){
 if(!userLat||!userLon)return;

 map=L.map('map').setView([userLat,userLon],13);

 L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
 ).addTo(map);

 L.marker([userLat,userLon])
  .addTo(map)
  .bindPopup("You are here");
}

// Load bars
async function findBars(){
 if(!userLat||!userLon){
  alert("Location not ready yet.");
  return;
 }

 const res=await fetch(`/specials?lat=${userLat}&lon=${userLon}`);
 const data=await res.json();

 let html="";

 if(data.length===0){
  html="<h3>No specials nearby.</h3>";
 }

 data.forEach(b=>{
  if(b[4]&&b[5]){
   L.marker([b[4],b[5]])
    .addTo(map)
    .bindPopup(b[0]);
  }

  html+=`
  <div class="card">
   <b>${b[0]}</b><br>
   Price: ${b[1]||"N/A"}<br>
   Day: ${b[2]||"Any"}<br>
   Notes: ${b[3]||""}<br>
   ${b[6]?"Distance: "+b[6]+" miles<br>":""}
   <a target="_blank"
    href="https://www.google.com/maps?q=${b[4]},${b[5]}">
    Directions
   </a>
  </div>`;
 });

 document.getElementById("results").innerHTML=html;
}
</script>

</body>
</html>
