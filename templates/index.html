<!DOCTYPE html>
<html>
<head>
<title>Dollar Beer Night</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family: Arial; margin:20px; }
#map { height:400px; margin-top:15px; }
.card { background:#f5f5f5; padding:10px; margin:10px 0; }
</style>
</head>

<body>

<h1>üç∫ Dollar Beer Night</h1>

<button onclick="findMe()">Find Specials Near Me</button>

<div id="map"></div>
<div id="results"></div>

<hr>

<h2>Add Special</h2>
<input id="name" placeholder="Bar Name"><br>
<input id="deal" placeholder="Special"><br>
<input id="address" placeholder="Address (optional)"><br>

<select id="day">
<option value="monday">Monday</option>
<option value="tuesday">Tuesday</option>
<option value="wednesday">Wednesday</option>
<option value="thursday">Thursday</option>
<option value="friday">Friday</option>
<option value="saturday">Saturday</option>
<option value="sunday">Sunday</option>
</select><br>

<button onclick="addSpecial()">Submit</button>

<script>
let map;
let markers = [];

function clearMarkers(){
    markers.forEach(m => map.removeLayer(m));
    markers = [];
}

function findMe(){
    navigator.geolocation.getCurrentPosition(pos => {

        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if(!map){
            map = L.map('map').setView([lat,lng],10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        clearMarkers();

        markers.push(
            L.marker([lat,lng]).addTo(map).bindPopup("You are here")
        );

        fetch(`/api/specials?lat=${lat}&lng=${lng}`)
        .then(r=>r.json())
        .then(data=>showResults(data));

    });
}

function showResults(data){
    const div=document.getElementById("results");
    div.innerHTML="";

    data.forEach(s=>{
        markers.push(
            L.marker([s.lat,s.lng]).addTo(map)
            .bindPopup(`${s.name}<br>${s.deal}<br>${s.distance} miles`)
        );

        div.innerHTML+=`
        <div class="card">
        <b>${s.name}</b><br>
        ${s.deal}<br>
        ${s.address}<br>
        ${s.distance} miles away
        </div>`;
    });
}

function addSpecial(){
    fetch("/api/add_special",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            name:document.getElementById("name").value,
            deal:document.getElementById("deal").value,
            address:document.getElementById("address").value,
            day:document.getElementById("day").value
        })
    }).then(()=>alert("Saved"));
}
</script>

</body>
</html>
