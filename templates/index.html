<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ğŸº Dollar Beer Night</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {font-family: Arial;padding:20px;}
input,select,button {width:100%;padding:10px;margin:5px 0;}
#map {height:400px;margin-top:10px;}
.card {background:#eee;padding:8px;margin:6px 0;}
</style>
</head>

<body>

<h1>ğŸº Dollar Beer Night</h1>

<h3>Add Special</h3>

<input id="name" placeholder="Bar Name">
<input id="deal" placeholder="Price (ex: 1.50)">
<input id="address" placeholder="City/State or Address">

<select id="day">
<option>Monday</option>
<option>Tuesday</option>
<option>Wednesday</option>
<option>Thursday</option>
<option>Friday</option>
<option>Saturday</option>
<option>Sunday</option>
</select>

<button onclick="save()">Save Special</button>
<button onclick="locate()">Locate Me</button>

<div id="map"></div>
<div id="list"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map=L.map("map").setView([41.1,-80.65],11);
let userLat=null,userLon=null;
let markers=[];

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);


// ---------- GEOCODE ----------
async function geocode(addr){
 const r=await fetch(
  `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`
 );
 const d=await r.json();
 if(!d.length){alert("Address not found");return null;}
 return {lat:+d[0].lat,lon:+d[0].lon};
}


// ---------- SAVE SPECIAL ----------
async function save(){
 const name=document.getElementById("name").value;
 const deal=document.getElementById("deal").value;
 const addr=document.getElementById("address").value;
 const day=document.getElementById("day").value;

 const coords=await geocode(addr);
 if(!coords)return;

 await fetch("/api/specials",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
   name,
   deal:+deal,
   addr,
   day,
   lat:coords.lat,
   lon:coords.lon
  })
 });

 load();
}


// ---------- LOCATE USER ----------
function locate(){
 navigator.geolocation.getCurrentPosition(p=>{
  userLat=p.coords.latitude;
  userLon=p.coords.longitude;
  map.setView([userLat,userLon],13);
  load();
 });
}


// ---------- LOAD TODAY'S SPECIALS ----------
async function load(){

 markers.forEach(m=>map.removeLayer(m));
 markers=[];

 const today=new Date().toLocaleDateString(
   "en-US",{weekday:"long"}
 );

 const r=await fetch(`/api/specials?day=${today}`);
 const data=await r.json();

 // cheapest first
 data.sort((a,b)=>a.deal-b.deal);

 list.innerHTML="";

 data.forEach(s=>{
  const m=L.marker([s.lat,s.lon])
   .addTo(map)
   .bindPopup(`<b>${s.name}</b><br>$${s.deal} â€” ${s.day}`);

  markers.push(m);

  list.innerHTML+=`
   <div class="card">
   <b>${s.name}</b> â€” $${s.deal}<br>
   ${s.addr}<br>
   Special Day: ${s.day}
   </div>`;
 });
}

load();
</script>

</body>
</html>
