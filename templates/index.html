<!DOCTYPE html><html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dollar Beer Night</title><link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script><style>
body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: auto;
    padding: 20px;
}

h2 {
    text-align: center;
}

input, textarea {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
}

button {
    padding: 12px;
    background: #2e7dff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

.card {
    background: #eee;
    padding: 12px;
    margin: 10px 0;
    border-radius: 8px;
}

#map {
    height: 320px;
    margin-top: 20px;
}
</style></head>
<body><h2>üç∫ Dollar Beer Night</h2><input id="lat" placeholder="Latitude" readonly>
<input id="lon" placeholder="Longitude" readonly><button onclick="findBars()">Find Specials Near Me</button>

<div id="map"></div><div id="results"></div><script>
let userLat = null;
let userLon = null;
let map = null;

/* Load saved location first */
window.onload = () => {
    const savedLat = localStorage.getItem("userLat");
    const savedLon = localStorage.getItem("userLon");

    if (savedLat && savedLon) {
        userLat = parseFloat(savedLat);
        userLon = parseFloat(savedLon);
        document.getElementById("lat").value = userLat;
        document.getElementById("lon").value = userLon;
        initMap();
    }

    getGPS();
};

/* GPS capture with persistence */
function getGPS() {
    navigator.geolocation.getCurrentPosition(
        pos => {
            userLat = pos.coords.latitude;
            userLon = pos.coords.longitude;

            document.getElementById("lat").value = userLat;
            document.getElementById("lon").value = userLon;

            localStorage.setItem("userLat", userLat);
            localStorage.setItem("userLon", userLon);

            initMap();
        },
        () => alert("Location permission helps find nearby specials.")
    );
}

/* Map initialization */
function initMap() {
    if (!userLat || !userLon) return;

    if (!map) {
        map = L.map('map').setView([userLat, userLon], 13);

        L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
        ).addTo(map);
    } else {
        map.setView([userLat, userLon], 13);
    }

    L.marker([userLat, userLon])
        .addTo(map)
        .bindPopup("You are here");
}

/* Bar finder */
async function findBars() {
    if (!userLat || !userLon) {
        alert("Location not ready yet.");
        return;
    }

    // Remove old markers
    map.eachLayer(layer => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
    });

    const res = await fetch(`/specials?lat=${userLat}&lon=${userLon}`);
    const data = await res.json();

    let html = "";

    if (data.length === 0) {
        html = "<h3>No specials nearby.</h3>";
    }

    data.forEach(b => {
        if (b[4] && b[5]) {
            L.marker([b[4], b[5]])
                .addTo(map)
                .bindPopup(b[0]);
        }

        html += `
        <div class="card">
            <b>${b[0]}</b><br>
            Price: ${b[1] || "N/A"}<br>
            Day: ${b[2] || "Any"}<br>
            Notes: ${b[3] || ""}<br>
            ${b[6] ? "Distance: " + b[6] + " miles<br>" : ""}
            <a target="_blank" href="https://www.google.com/maps?q=${b[4]},${b[5]}">
            Directions</a>
        </div>`;
    });

    document.getElementById("results").innerHTML = html;
}
</script></body>
</html>
