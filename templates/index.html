<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Dollar Beer Night</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{font-family:Arial;padding:10px;background:#f4f4f4;}
input,button{width:100%;padding:10px;margin:6px 0;}
#map{height:400px;margin-top:10px;}
.result{background:white;padding:8px;margin:6px 0;}
</style>
</head>

<body>

<h2>üç∫ Dollar Beer Night</h2>

<h3>Add Special</h3>

<input id="barName" placeholder="Bar Name">
<input id="deal" placeholder="$1.50 cans etc">
<input id="address" placeholder="City / State / Address">
<input id="day" placeholder="Sunday‚ÄìSaturday">

<button onclick="addSpecial()">Save Special</button>

<hr>

<button onclick="locate()">Find Beer Near Me</button>

<div id="map"></div>
<div id="results"></div>

<script>
let map=L.map('map').setView([41.08,-80.65],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
maxZoom:19}).addTo(map);

let userLat,userLng;


// ---------- GEOCODING ----------

async function geocode(addr){
const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`;
const res=await fetch(url);
const data=await res.json();
if(!data.length) return null;
return {
lat:parseFloat(data[0].lat),
lng:parseFloat(data[0].lon)
};
}


// ---------- ADD SPECIAL ----------

async function addSpecial(){

const name=document.getElementById('barName').value.trim();
const deal=document.getElementById('deal').value.trim();
const address=document.getElementById('address').value.trim();
const day=document.getElementById('day').value.trim();

if(!name||!deal||!address||!day){
alert("Fill everything");
return;
}

const coords=await geocode(address);

if(!coords){
alert("Address not found");
return;
}

await fetch('/api/specials',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
name,
deal,
address,
day,
lat:coords.lat,
lng:coords.lng
})
});

alert("Saved!");
}


// ---------- FIND NEARBY ----------

function locate(){

navigator.geolocation.getCurrentPosition(pos=>{

userLat=pos.coords.latitude;
userLng=pos.coords.longitude;

map.setView([userLat,userLng],11);

L.marker([userLat,userLng])
.addTo(map)
.bindPopup("You are here");

loadSpecials();

});
}


// ---------- DISTANCE CALC ----------

function milesBetween(lat1,lon1,lat2,lon2){

const R=3958.8;
const dLat=(lat2-lat1)*Math.PI/180;
const dLon=(lon2-lon1)*Math.PI/180;

const a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*
Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;

return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}


// ---------- LOAD TODAY SPECIALS ----------

async function loadSpecials(){

const res=await fetch('/api/specials');
const specials=await res.json();

document.getElementById('results').innerHTML="";

specials.forEach(s=>{

const dist=milesBetween(userLat,userLng,s.lat,s.lng);

if(dist<=60){

const marker=L.marker([s.lat,s.lng])
.addTo(map)
.bindPopup(`
<b>${s.name}</b><br>
${s.deal}<br>
${dist.toFixed(1)} miles<br>
${s.validated?"‚úî Validated":"User Submitted"}
`);

const div=document.createElement("div");
div.className="result";
div.innerHTML=`
<b>${s.name}</b> ‚Äî ${s.deal}<br>
${dist.toFixed(1)} miles<br>
${s.validated?"‚úî Verified":"User Entry"}
`;

document.getElementById('results').appendChild(div);

}

});

}

</script>

</body>
</html>
